<xhtml:html xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting"
    xmlns:xhtml="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:widget="http://orbeon.org/oxf/xml/widget"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:xxbl="http://orbeon.org/oxf/xml/xbl"
    xmlns:exf="http://www.exforms.org/exf/1-0"
    xmlns:exforms="http://www.exforms.org/exf/1-0"
    xmlns:howto="http://www.orbeon.com/howto">

    <xhtml:head>
        <xhtml:title>Dialog editor component</xhtml:title>
        <xforms:model xxforms:xhtml-layout="span">

            <xforms:instance>
                <instance>
                    <text>
                        This should never now (it is non-relevant).
                    </text>
                    <text>
                        All the world's a stage, and all the men and women merely players: they have their exits and
                        their entrances; and one man in his time plays many parts...
                    </text>
                    <text>To be or not to be– that is the question: Whether 'tis nobler in the mind to suffer The slings
                        and arrows of outrageous fortune, Or to take arms against a sea of troubles And, by opposing,
                        end them. To die, to sleep No more – and by a sleep to say we end The heartache and the thousand
                        natural shocks That flesh is heir to – ‘tis a consummation Devoutly to be wished. To die, to
                        sleep To sleep, perchance to dream. Ay, there's the rub, For in that sleep of death what dreams
                        may come, When we have shuffled off this mortal coil, Must give us pause. There's the respect
                        That makes calamity of so long life. For who would bear the whips and scorns of time, Th’
                        oppressor's wrong, the proud man's contumely, The pangs of despised love, the law's delay, The
                        insolence of office, and the spurns That patient merit of th’ unworthy takes, When he himself
                        might his quietus make With a bare bodkin? Who would fardels bear, To grunt and sweat under a
                        weary life, But that the dread of something after death, The undiscovered country from whose
                        bourn No traveler returns, puzzles the will And makes us rather bear those ills we have Than fly
                        to others that we know not of? Thus conscience does make cowards of us all, And thus the native
                        hue of resolution Is sicklied o'er with the pale cast of thought, And enterprises of great
                        pitch and moment With this regard their currents turn awry, And lose the name of action.—Soft
                        you now! The fair Ophelia! Nymph, in thy orisons Be all my sins remembered.
                    </text>
                </instance>
            </xforms:instance>

            <xforms:bind nodeset="text[1]" relevant="false()"/>
            <xforms:bind nodeset="text[3]" readonly="true()"/>

            <xforms:action ev:event="xforms-model-construct-done" xxforms:iterate="text">
                <xforms:setvalue ref="." value="normalize-space(.)"/>
            </xforms:action>
        </xforms:model>

        <xbl:xbl>
            <xbl:binding id="howto-dialog-editor" element="howto|dialog-editor">
                <xbl:implementation>
                    <xforms:model>
                        <xforms:instance>
                            <text readonly=""/>
                        </xforms:instance>
                        <xforms:bind nodeset="." readonly="@readonly = 'true'"/>
                    </xforms:model>
                </xbl:implementation>
                <xbl:resources>
                    <xbl:style>
                        <!-- Align label and button to the top of the area showing the text -->
                        .xbl-howto-dialog-editor .xforms-label { vertical-align: top }
                        .xbl-howto-dialog-editor .xbl-fr-button { vertical-align: top }

                        <!-- Styling for the area showing the text -->
                        .xbl-howto-dialog-editor .xforms-output-output {
                            border: 1px solid #999; padding: 2px; display: inline-block;
                            margin: 0 .5em 0 1em; overflow-y: scroll; width: 20em; height: 5em;
                            background-color: #eee }

                        <!-- Styling for the dialog and its content -->
                        .howto-dialog-editor-dialog { width: 400px }
                        .howto-dialog-editor-dialog textarea { width: 100%; height: 200px }
                        .howto-dialog-editor-dialog .xforms-label { display: none }
                        .howto-dialog-editor-dialog .howto-dialog-editor-buttons {
                            text-align: right; padding-right: .5em; padding-top: .5em;
                            padding-bottom: .5em; margin-top: .5em; border-top: 2px solid #DDDDEE; clear: both }
                        .howto-dialog-editor-dialog .howto-dialog-editor-buttons button img { margin-right: .5em; }
                        .howto-dialog-editor-dialog .howto-dialog-editor-positive .xbl-fr-button .yui-button button {
                            background: url(../../../apps/fr/style/images/silk/tick.png) no-repeat 5px; padding: 0 10px 0 25px;}
                        .howto-dialog-editor-dialog .howto-dialog-editor-negative .xbl-fr-button .yui-button button {
                            background: url(../../../apps/fr/style/images/silk/cross.png) no-repeat 5px; padding: 0 10px 0 25px;}

                    </xbl:style>
                </xbl:resources>
                <xbl:template>
                    <xforms:group appearance="xxforms:internal" id="container">
                        <xxforms:variable name="internal" select="."/>
                        <xxforms:variable name="external">
                            <xxforms:sequence xbl:attr="select=ref" xxbl:scope="outer"/>
                            <xforms:setvalue ev:event="xforms-enabled" ref="$internal/@readonly" value="exforms:readonly($external)"/>
                            <xforms:setvalue ev:event="xforms-readonly" ref="$internal/@readonly">true</xforms:setvalue>
                            <xforms:setvalue ev:event="xforms-readwrite" ref="$internal/@readonly">false</xforms:setvalue>
                        </xxforms:variable>

                        <xforms:group ref="$external">
                            <!-- Display value -->
                            <xforms:output ref=".">
                                <xbl:content includes="xforms|label,xforms|help,xforms|hint,xforms|alert"/>
                            </xforms:output>
                            <!-- Button to open dialog -->
                            <fr:button id="open" class="howto-dialog-editor-open">
                                <xforms:label value="if (exforms:readonly($external)) then 'View' else 'Edit'"/>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="$internal" value="$external"/>
                                    <xxforms:show dialog="dialog"/>
                                    <xforms:setfocus control="textarea"/>
                                </xforms:action>
                            </fr:button>
                        </xforms:group>

                        <!-- Dialog to edit value -->
                        <xxforms:dialog id="dialog" class="howto-dialog-editor-dialog">
                            <xbl:content includes="xforms|label"/>
                            <xforms:textarea ref="$internal" id="textarea">
                                <xbl:content includes="xforms|label,xforms|help,xforms|hint,xforms|alert"/>
                            </xforms:textarea>
                            <xhtml:div class="howto-dialog-editor-buttons">
                                <xforms:group appearance="xxforms:internal">
                                    <xxforms:hide ev:event="DOMActivate" dialog="dialog"/>
                                    <fr:button class="howto-dialog-editor-positive">
                                        <xforms:label>OK</xforms:label>
                                        <xforms:setvalue ev:event="DOMActivate" ref="$external" value="$internal"/>
                                    </fr:button>
                                    <fr:button class="howto-dialog-editor-negative">
                                        <xforms:label>Cancel</xforms:label>
                                    </fr:button>
                                </xforms:group>
                            </xhtml:div>
                        </xxforms:dialog>
                    </xforms:group>
                </xbl:template>
            </xbl:binding>
        </xbl:xbl>

        <xhtml:style type="text/css">
            .xforms-repeat-selected-item-1 { background-color: transparent  }
        </xhtml:style>
    </xhtml:head>
    <xhtml:body>

        <xforms:repeat nodeset="text">
            <howto:dialog-editor ref=".">
                <xforms:label>Excerpt</xforms:label>
            </howto:dialog-editor>
        </xforms:repeat>

        <fr:button>
            <xforms:label>Add</xforms:label>
            <xforms:insert ev:event="DOMActivate" nodeset="text" origin="xxforms:element('text')"/>
        </fr:button>

    </xhtml:body>
</xhtml:html>
